# CrewPlanner — Project Status & Developer Guide

## Project Overview

**CrewPlanner** is a team management app for a sailing team (~10-20 members), replacing WhatsApp with structured event planning, availability tracking, task management, and team communication. All UI text is in Dutch.

**Live URL:** https://crew-planner.vercel.app

---

## Tech Stack

| Technology | Purpose |
|---|---|
| Next.js 16 (App Router) | Framework, server actions |
| TypeScript | Type safety |
| Prisma 7.4 + Neon | PostgreSQL ORM + serverless DB |
| Clerk | Authentication & user management |
| Resend | Transactional email |
| Vercel Blob | File storage (post attachments) |
| Tailwind CSS 4 + shadcn/ui | Styling & components |
| Zod | Form validation |
| Sonner | Toast notifications |
| web-push | Web Push notifications (VAPID) |

---

## Environment Variables

| Variable | Where | Required | Notes |
|---|---|---|---|
| `DATABASE_URL` | `.env` | Yes | Neon Postgres connection string (set by Neon integration) |
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | `.env.local` | Yes | Clerk public key |
| `CLERK_SECRET_KEY` | `.env.local` | Yes | Clerk server key |
| `BLOB_READ_WRITE_TOKEN` | `.env.local` | Yes | Vercel Blob token for file uploads |
| `RESEND_API_KEY` | `.env.local` + Vercel | Yes | Resend email API key |
| `NEXT_PUBLIC_APP_URL` | `.env.local` + Vercel | No | Defaults to `https://crew-planner.vercel.app` |
| `CRON_SECRET` | Vercel only | Auto | Auto-generated by Vercel for cron auth |
| `NEXT_PUBLIC_VAPID_PUBLIC_KEY` | `.env.local` + Vercel | Yes | VAPID public key for web push (safe to expose) |
| `VAPID_PRIVATE_KEY` | `.env.local` + Vercel | Yes | VAPID private key for web push (server only) |

---

## Project Structure

```
prisma/schema.prisma          # Database schema (source of truth)
src/
├── app/
│   ├── (app)/                 # Authenticated app routes
│   │   ├── page.tsx           # Dashboard
│   │   ├── evenementen/       # Events: list, detail, create, edit
│   │   ├── informatie/        # Posts: list, detail, create, edit
│   │   ├── taken/             # Tasks: list, detail, create
│   │   ├── beheer/            # Admin: members, task groups, stats
│   │   └── inbox/             # Notifications
│   ├── (auth)/                # Sign-in / sign-up (Clerk)
│   └── api/
│       ├── upload/            # File upload (Vercel Blob)
│       ├── notifications/     # Notification count
│       ├── push/              # Push subscribe/unsubscribe endpoints
│       └── cron/herinneringen/# Daily reminder cron job
├── components/
│   ├── events/                # EventForm, EventCard, AvailabilityButtons, AvailabilityOverview
│   ├── posts/                 # PostForm, PostCard
│   ├── tasks/                 # TaskForm, TaskCard, TaskActions, TaskGroupManager
│   ├── comments/              # CommentForm, CommentThread
│   ├── dashboard/             # EventHero, PendingEvents, RecentPosts, OpenTasks
│   ├── admin/                 # TeamMemberList, StatsDashboard, MemberStatsTable
│   ├── shared/                # PageHeader, EmptyState, StatusBadge, UserAvatar, MemberPicker, SearchInput, ConfirmDialog
│   ├── layout/                # Header, Sidebar, BottomNav, NotificationBell, NotificationItem, PushToggle
│   └── ui/                    # shadcn/ui primitives
└── lib/
    ├── auth.ts                # getCurrentUserId, isAdmin, requireAdmin, getUserRole
    ├── prisma.ts              # Prisma client (Neon adapter)
    ├── users.ts               # resolveUsers / resolveUser (Clerk → ResolvedUser)
    ├── utils.ts               # cn, formatDatum, formatDatumKort, formatTijd, relatieveDatum
    ├── constants.ts           # Label/color maps for all enums
    ├── types.ts               # EventWithBeschikbaarheid, TaskWithGroup, ActionResult, etc.
    ├── email.ts               # Resend client (lazy init), FROM_EMAIL, APP_URL
    ├── push.ts                # web-push client (lazy init), sendPushToUsers()
    ├── email-templates/       # HTML email templates (Dutch): nieuw-evenement, herinnering, taak-toegewezen
    ├── validations/           # Zod schemas: events, tasks, posts
    ├── actions/               # Server actions: events, posts, tasks, comments, notifications, emails, users
    └── queries/               # Data fetching: events, posts, tasks, comments, notifications, dashboard, stats
```

---

## Database Models

| Model | Purpose |
|---|---|
| `Event` | Events with type, date, location, deadline |
| `Beschikbaarheid` | Per-user availability response per event |
| `EventUitnodiging` | Which users are invited to an event |
| `EventHerinnering` | Scheduled reminder config per event |
| `EventHerinneringLog` | Per-user reminder delivery log (event + user + timestamp) |
| `Post` | Information posts with categories |
| `PostFile` | File attachments on posts |
| `Comment` | Polymorphic comments on events/posts/tasks |
| `TaskGroup` | Grouping for tasks |
| `Task` | Tasks with status, assignment, claiming |
| `Notification` | In-app notifications |
| `PushSubscription` | Web push subscription per user (endpoint, VAPID keys) |

---

## Key Patterns

- **Server Components** by default; `"use client"` only where needed (forms, interactivity)
- **Server Actions** for all mutations (`"use server"` in action files)
- **Form pattern**: `useActionState` + native `<form action={}>` + `FormData` + Zod validation
- **Auth**: `requireAdmin()` for admin-only actions, `getCurrentUserId()` for any user
- **Notifications**: `notifyMembers()`, `notifyAdmins()`, `notifySpecificUsers()` helpers
- **Email**: All email sends wrapped in try/catch with `RESEND_API_KEY` guard — failures never break the main action
- **Push**: `sendPushToUsers()` called alongside email in notification helpers — same try/catch pattern, expired subscriptions auto-cleaned
- **User resolution**: Clerk user IDs stored in DB, resolved via `resolveUsers()` at render time

---

## Phase 1 (Complete) — MVP

- Clerk authentication (Dutch localization)
- Events CRUD with availability tracking (3 states + mandatory reason)
- Information center (posts, categories, search, pinning, file attachments)
- Contextual comments on events, posts, and tasks
- Tasks with groups, claiming, completion
- Dashboard with next event hero, pending events, recent posts, open tasks
- Notification system (in-app)
- Admin page with team member role management + task group management
- Responsive design (mobile-first)

## Phase 2 (Complete) — Invitations, Email, Stats

### Event Invitations
- `EventUitnodiging` join table — admins select which members to invite per event
- `MemberPicker` component with "Alle leden" toggle vs manual selection
- Members only see events they're invited to; admins see all
- Response ratio based on invited count (not global member count)
- "Niet gereageerd" section shows non-responders on event detail

### Email Notifications (Resend)
- Event invite emails sent on event creation
- Task assignment emails sent when `toegewezenAan` is set
- Reminder emails sent via daily cron to non-responders
- Templates: `nieuw-evenement`, `herinnering`, `taak-toegewezen`
- Sending domain: configured in `src/lib/email.ts` (`FROM_EMAIL`)

### Automated Reminders
- `EventHerinnering` records created per event (configurable: 2/3/5/2+5 days after creation)
- Reminder timing changed from "days before deadline" to "days after event creation" (`dagenNaAanmaak`)
- Vercel cron at `/api/cron/herinneringen` runs daily at 08:00 UTC
- Sends email + in-app `HERINNERING` notification to non-responders
- Auth: `CRON_SECRET` header verification

### Per-User Reminder Tracking
- `EventHerinneringLog` model tracks which users received which reminders (per event, per user, with timestamp)
- Cron job creates a log entry for each user when a reminder is sent
- Event detail page shows bell icon with reminder count next to each user (both responders and non-responders)
- `AvailabilityOverview` component receives `herinneringLogs` prop and displays per-user counts
- `getEventById` query includes `herinneringLogs` relation

### Past/Upcoming Event Split
- Events page shows upcoming events by default
- Past events in collapsible "Afgelopen evenementen" section (muted styling)

### Task Assignment
- `<Select>` in task form to assign a member
- Assignee shown on task cards (avatar + name) and detail page
- `TAAK_TOEGEWEZEN` in-app notification + email on assignment

### Admin Stats Dashboard
- **Opkomst**: per member — invited, responded, beschikbaar, opkomst%
- **Afgeronde taken**: per member — completed task count
- **Responstijd**: per member — average hours to respond
- Located on Beheer page below team members and task groups

---

### End Time Simplification
- Event `eindtijd` field changed from full `datetime-local` input to `time` input only
- End time is stored as a full DateTime but only the time portion is used in the UI
- Event form uses `toTimeLocal()` helper to extract HH:MM from the stored DateTime

---

## Phase 3 (In Progress) — Push Notifications & Polish

### Web Push Notifications (Complete)
- `web-push` package with VAPID authentication
- `PushSubscription` model stores per-user browser push subscriptions (endpoint, p256dh, auth)
- Service worker (`public/sw.js`) handles `push` and `notificationclick` events
- API routes: `POST /api/push/subscribe` (upsert) and `POST /api/push/unsubscribe` (delete)
- `PushToggle` component in header — registers SW, manages subscription, shows bell-ring/bell-off icon
- `sendPushToUsers()` helper (lazy init, same pattern as email) called in `notifyMembers`, `notifySpecificUsers`, `notifyAdmins`
- Expired subscriptions (HTTP 410/404) auto-deleted on send failure
- PWA manifest (`src/app/manifest.ts`) + app icons for iOS "Add to Home Screen" push support
- **Deploy note**: `NEXT_PUBLIC_VAPID_PUBLIC_KEY` and `VAPID_PRIVATE_KEY` must be set in Vercel env vars

### Untracked files (not committed)
- `scripts/seed-reminders.ts` — Seeds `EventHerinneringLog` entries for existing events (testing tool)
- `scripts/inspect-events.ts` — Inspects events with invitations, responses, and reminder logs (debugging tool)
- `scripts/seed-test-scenario.ts` — Creates a full test event with invited users, varied responses, and reminder logs
- `screenshots/` — Error screenshots from debugging session

---

## Phase 4 (Planned / Not Started)

- AI Assistant (chat interface with Anthropic Claude API + tool use)
- Calendar integration (iCal export)
- Season overviews / reports
- Advanced file management

---

## Development Commands

```bash
npm run dev          # Start dev server
npm run build        # Production build (includes prisma generate)
npm run lint         # ESLint
npm run db:generate  # Regenerate Prisma client
npm run db:push      # Push schema to DB (no migration history)
npm run db:migrate   # Create migration (dev)
npm run db:seed      # Seed database
```

---

## Deployment

- Push to `main` triggers automatic Vercel deployment
- Database schema changes: run `npx prisma db push` or deploy will use `prisma generate` in build script
- Cron jobs configured in `vercel.json`
- Make sure `RESEND_API_KEY`, `NEXT_PUBLIC_VAPID_PUBLIC_KEY`, and `VAPID_PRIVATE_KEY` are set in Vercel environment variables
